#WIFI Version 2.6

WIFILE=~/.wifi.csv
WIFACE=wlan0

if [ "$1" == "$*" ]
then
	PROFILE_NAME=$1
else
	PROFLE_NAME=$(cat $WIFILE|awk -F, '{print $1}'|dmenu -b $*)
fi

if [ -z $(cat $WIFILE|grep $PROFILE_NAME)]
then
	echo "Using first arg as ESSID."
	ESSID=$PROFILE_NAME
else
	ESSID_VALUE=$(cat $WIFILE|grep $PROFLE_NAME|awk -F, '{print $2}')
	WEP_KEY_VAL=$(cat $WIFILE|grep $PROFLE_NAME|awk -F, '{print $3}')
	WPA_KEY_LOC=$(cat $WIFILE|grep $PROFLE_NAME|awk -F, '{print $4}')
	ESSID=$ESSID_VALUE
fi

#WEP HANDLING
if [ -z $WEP_KEY_VAL ]
then
#	echo "According to the profile, this AP has no WEP encryption."
	echo ""
else
	echo "Poor security is better than no security."
	WEP="enc $WEP_KEY_VAL"
fi

#WPA HANDLING
if [ -z $WPA_KEY_LOC ]
then
	echo "According to the profile, this AP has no WPA encryption."
else
	sudo wpa_supplicant -i$WIFACE -c$WPA_KEY_LOC&
fi

#MESH HANDLING(XOs only)
if [ -z $PROFLE_NAME ]
then
	exit 0
elif [ $PROFLE_NAME == mesh ]
then
	sudo iwconfig $WIFACE mode ad-hoc essid mesh
	sudo iwconfig msh0 channel 6
	sudo ifconfig msh0 $2
	sudo echo "mesh-up: this node IP address is $2"
else
	sudo iwconfig $WIFACE mode managed essid $ESSID $WEP
	sudo dhclient -r $WIFACE&>/dev/null
	sudo dhclient $WIFACE&>/dev/null
fi

CUR_ESSID=$(/sbin/iwconfig $WIFACE|grep ESSID|awk '{print $4}'|sed s/ESSID://)
LINK_QUAL=`iwconfig $WIFACE|grep Quality|awk '{print $2}'|sed -e "s/.*Quality=//"`
CUR_IPADR=`/sbin/ifconfig $WIFACE|grep "inet addr"|sed -e "s/.*inet addr://"|sed -e "s/Bcast.*//"`
echo $WIFACE: $CUR_ESSID $LINK_QUAL"  "IP: $CUR_IPADR > .wifi_stats

#See LICENSE file for copyright and license details
